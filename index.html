<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Winter AI</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #1e1e1e;
    color: #fff;
  }
  h1 {
    text-align: center;
  }
  .container {
    display: flex;
    border: 2px solid #fff;
    height: 80vh;
  }
  /* Left 3D Model Container */
  #model-container {
    flex: 1;
    border: 2px solid #fff;
    margin: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: black;
  }
  #model-video {
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: black;
  }
  /* Right Chat Container */
  #chat-container {
    flex: 2;
    border: 2px solid #fff;
    margin: 5px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  #chat {
    flex: 1;
    border-bottom: 1px solid #555;
    padding: 10px;
    overflow-y: auto;
    background: #2b2b2b;
  }
  .msg { margin: 5px 0; }
  .user { color: white; }
  .ai { color: #03a9f4; }
  .input-area {
    display: flex;
    padding: 10px;
    gap: 5px;
  }
  #prompt {
    flex: 1;
    padding: 8px;
    font-size: 1em;
    border: 1px solid #555;
    background: #111;
    color: #fff;
  }
  button {
    padding: 8px 16px;
    font-size: 1em;
    background: #03a9f4;
    color: #fff;
    border: none;
    cursor: pointer;
  }
  button:hover {
    background: #0288d1;
  }
</style>
</head>
<body>
<h1>Winter AI</h1>
<div class="container">
  <div id="model-container">
    <video id="model-video" autoplay loop muted playsinline>
      <source src="https://raw.githubusercontent.com/darrk5200/notani/main/idle_02.mp4" type="video/mp4">
    </video>
  </div>

  <div id="chat-container">
    <div id="chat"></div>
    <div class="input-area">
      <input type="text" id="prompt" placeholder="Type your message..." />
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>
</div>

<script>
const API_KEY_MAIN = "AIzaSyCX2Iaj5M6rwV5enikVyc4Gn6MRPsvTAj4";
const ELEVENLABS_API_KEY = "sk_4405c05ca25318e922210fbdaca91319c22cd89afca5de29";
const ELEVENLABS_VOICE_ID = "emSmWzY0c0xtx5IFMCVv";

const idleVideo = "https://raw.githubusercontent.com/darrk5200/notani/main/idle_02.mp4";
const talkVideo = "https://raw.githubusercontent.com/darrk5200/notani/main/talk_01.mp4";
const waveVideo = "https://raw.githubusercontent.com/darrk5200/notani/main/wave_01.mp4";
const modelVideo = document.getElementById("model-video");

let conversationHistory = [];

// --- Play wave intro on first load ---
window.addEventListener("DOMContentLoaded", () => {
  modelVideo.src = waveVideo;
  modelVideo.loop = false;
  modelVideo.play();

  modelVideo.onended = () => {
    playVideo(idleVideo); // switch to idle after wave
  };
});

async function askAI(prompt, key, maxTokens = 200) {
  const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      contents: [{ parts: [{ text: prompt }] }],
      generationConfig: { maxOutputTokens: maxTokens },
      safetySettings: [
        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
      ],
    }),
  });
  if (!res.ok) throw new Error(`Gemini API error: ${res.status}`);
  
  const data = await res.json();
  return data?.candidates?.[0]?.content?.parts?.[0]?.text?.trim() ?? "(No reply)";
}

async function getElevenLabsAudio(text) {
  const url = `https://api.elevenlabs.io/v1/text-to-speech/${ELEVENLABS_VOICE_ID}`;
  const res = await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "xi-api-key": ELEVENLABS_API_KEY
    },
    body: JSON.stringify({
      text: text,
      model_id: "eleven_multilingual_v2",
      voice_settings: { stability: 0.1, similarity_boost: 0.7 }
    })
  });

  if (!res.ok) throw new Error(`ElevenLabs API error: ${res.status}`);

  const audioData = await res.arrayBuffer();
  const audioBlob = new Blob([audioData], { type: "audio/mpeg" });
  return URL.createObjectURL(audioBlob);
}

function playVideo(src) {
  modelVideo.src = src;
  modelVideo.loop = true;
  modelVideo.play();
}

async function sendMessage() {
  const input = document.getElementById("prompt");
  const userText = input.value.trim();
  if (!userText) return;

  addMessage("You", userText, "user");
  conversationHistory.push({ role: "User", text: userText });
  input.value = "";

  try {
    let conversationStr = conversationHistory.map(msg => `${msg.role}: ${msg.text}`).join("\n");
    let fullPrompt = `Prompt: ${userText}\nConversation so far:\n${conversationStr}\nYou are Winter, a lively 17-year-old girl. Keep it casual and short.`;

    const reply = await askAI(fullPrompt, API_KEY_MAIN);

    const placeholderDiv = document.createElement("div");
    placeholderDiv.className = "msg ai";
    placeholderDiv.innerHTML = `<strong>Winter:</strong> <em>Winter is thinking...</em>`;
    document.getElementById("chat").appendChild(placeholderDiv);
    document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight;

    const audioUrl = await getElevenLabsAudio(reply);

    placeholderDiv.innerHTML = `<strong>Winter:</strong> ${reply}`;
    conversationHistory.push({ role: "You", text: reply });

    const audio = new Audio(audioUrl);

    // Start talking animation when audio starts
    audio.onplay = () => {
      playVideo(talkVideo);
    };

    audio.onended = () => {
      // Switch back to idle animation
      playVideo(idleVideo);
    };

    audio.play();

  } catch (err) {
    addMessage("Error", err.message, "ai");
  }
}

function addMessage(sender, text, cls) {
  const chat = document.getElementById("chat");
  const div = document.createElement("div");
  div.className = `msg ${cls}`;
  div.innerHTML = `<strong>${sender}:</strong> ${text}`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

document.addEventListener('keydown', function(event) {
  if (event.key === 'Enter') {
    sendMessage();
  }
});
</script>
</body>
</html>
